# =========================================================
# GitHub Actions: Auto-deploy to Ubuntu server on push to main
# =========================================================
# 
# Required GitHub Secrets (Settings â†’ Secrets â†’ Actions):
#   SERVER_HOST     â€” IP Ð°Ð´Ñ€ÐµÑ ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 185.123.45.67)
#   SERVER_USER     â€” SSH Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ ubuntu)
#   SERVER_SSH_KEY  â€” ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡ (ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ id_rsa / id_ed25519)
#   DEPLOY_PATH     â€” ÐŸÑƒÑ‚ÑŒ Ðº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ /home/ubuntu/yandex-maps-bot)
#

name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: ðŸš€ Deploy to Ubuntu Server
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
            
            set -e
            
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            
            echo "ðŸ“¥ Pulling latest code..."
            cd "$DEPLOY_PATH"
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ”¨ Building Docker images..."
            docker compose build
            
            echo "ðŸ”„ Restarting services..."
            docker compose up -d postgres redis app celery_worker celery_beat
            
            echo "â³ Waiting for startup..."
            sleep 15
            
            echo "ðŸ¥ Health check..."
            if curl -sf http://localhost:8000/health; then
              echo ""
              echo "âœ… Deploy successful!"
            else
              echo "âš ï¸ Health check failed, showing logs:"
              docker compose logs --tail=30 app
              exit 1
            fi
            
            echo "ðŸ§¹ Cleanup..."
            docker image prune -f
            
            echo "âœ… Done!"
          DEPLOY_SCRIPT

      - name: âŒ Deploy failed
        if: failure()
        run: echo "::error::Deployment failed! Check the logs above."
