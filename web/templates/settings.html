{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤ ‚Äî Yandex Maps Bot{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-sliders"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadWorkerStatus()">
            <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>
</div>

<!-- Status Cards Row -->
<div class="row mb-4" id="statusCards">
    <div class="col-md-4">
        <div class="card stats-card border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="bi bi-fire text-primary" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-subtitle text-muted">–ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–æ—Ñ–∏–ª–µ–π</h6>
                        <h4 class="card-title mb-0">
                            <span id="warmupQueueLen">-</span> <small class="text-muted">–≤ –æ—á–µ—Ä–µ–¥–∏</small>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card border-success">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="bi bi-geo-alt-fill text-success" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-subtitle text-muted">–Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</h6>
                        <h4 class="card-title mb-0">
                            <span id="mapsQueueLen">-</span> <small class="text-muted">–≤ –æ—á–µ—Ä–µ–¥–∏</small>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card border-warning">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="bi bi-search text-warning" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="card-subtitle text-muted">–Ø–Ω–¥–µ–∫—Å –ü–æ–∏—Å–∫</h6>
                        <h4 class="card-title mb-0">
                            <span id="searchQueueLen">-</span> <small class="text-muted">–≤ –æ—á–µ—Ä–µ–¥–∏</small>
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workers Configuration -->
<div class="row">
    <!-- Warmup Worker -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-fire"></i> –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–æ—Ñ–∏–ª–µ–π</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="warmupEnabled" checked>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small">–ü—Ä–æ–≥—Ä–µ–≤ –±—Ä–∞—É–∑–µ—Ä–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ –∑–∞–¥–∞—á–∞—Ö. –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ—Å–µ—â–∞—é—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–∞–π—Ç—ã –¥–ª—è –Ω–∞–±–æ—Ä–∞ cookies –∏ –∏—Å—Ç–æ—Ä–∏–∏.</p>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">–ü–æ—Ç–æ–∫–∏ (concurrency)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('warmupConcurrency', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="warmupConcurrency" value="5" min="1" max="50">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('warmupConcurrency', 1)">+</button>
                    </div>
                    <small class="text-muted">–°–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ñ–∏–ª–µ–π –ø—Ä–æ–≥—Ä–µ–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ (–ì–ë)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('warmupMemory', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="warmupMemory" value="16" min="1" max="128">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('warmupMemory', 1)">+</button>
                    </div>
                    <small class="text-muted">~2 –ì–ë –Ω–∞ –ø–æ—Ç–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–û—á–µ—Ä–µ–¥–∏</label>
                    <div>
                        <span class="badge bg-primary">warmup</span>
                        <span class="badge bg-secondary">default</span>
                        <span class="badge bg-info">proxy</span>
                        <span class="badge bg-dark">maintenance</span>
                    </div>
                </div>

                <div class="alert alert-light border small mb-0">
                    <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á:</strong> <span id="warmupActiveTasks">-</span><br>
                    <strong>–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</strong> <span id="warmupTotalTasks">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Yandex Maps Worker -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-geo-alt-fill"></i> –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="mapsEnabled" checked>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small">–ö–ª–∏–∫–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –Ω–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö. –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ, —á—Ç–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤, —Å–∫—Ä–æ–ª–ª, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–∞—Ä—Ç–æ–π.</p>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">–ü–æ—Ç–æ–∫–∏ (concurrency)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('mapsConcurrency', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="mapsConcurrency" value="3" min="1" max="50">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('mapsConcurrency', 1)">+</button>
                    </div>
                    <small class="text-muted">–°–∫–æ–ª—å–∫–æ –≤–∏–∑–∏—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ (–ì–ë)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('mapsMemory', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="mapsMemory" value="8" min="1" max="128">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('mapsMemory', 1)">+</button>
                    </div>
                    <small class="text-muted">~2 –ì–ë –Ω–∞ –ø–æ—Ç–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–û—á–µ—Ä–µ–¥—å</label>
                    <div>
                        <span class="badge bg-success">yandex_maps</span>
                    </div>
                </div>

                <div class="alert alert-light border small mb-0">
                    <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á:</strong> <span id="mapsActiveTasks">-</span><br>
                    <strong>–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</strong> <span id="mapsTotalTasks">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Yandex Search Worker -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-search"></i> –Ø–Ω–¥–µ–∫—Å –ü–æ–∏—Å–∫</span>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="searchEnabled" checked>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small">–ö–ª–∏–∫–∏ –ø–æ –≤—ã–¥–∞—á–µ –Ø–Ω–¥–µ–∫—Å–∞ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–∞–π—Ç. –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ —Å–∞–π—Ç–∞ –≤ –≤—ã–¥–∞—á–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥.</p>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">–ü–æ—Ç–æ–∫–∏ (concurrency)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('searchConcurrency', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="searchConcurrency" value="3" min="1" max="50">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('searchConcurrency', 1)">+</button>
                    </div>
                    <small class="text-muted">–°–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤ –ø–æ –≤—ã–¥–∞—á–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–õ–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ (–ì–ë)</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('searchMemory', -1)">‚àí</button>
                        <input type="number" class="form-control text-center" id="searchMemory" value="8" min="1" max="128">
                        <button class="btn btn-outline-secondary" onclick="adjustValue('searchMemory', 1)">+</button>
                    </div>
                    <small class="text-muted">~2 –ì–ë –Ω–∞ –ø–æ—Ç–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">–û—á–µ—Ä–µ–¥—å</label>
                    <div>
                        <span class="badge bg-warning text-dark">yandex_search</span>
                    </div>
                </div>

                <div class="alert alert-light border small mb-0">
                    <strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á:</strong> <span id="searchActiveTasks">-</span><br>
                    <strong>–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:</strong> <span id="searchTotalTasks">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <p class="mb-0 text-muted">
                        <i class="bi bi-info-circle"></i>
                        –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª, –∑–∞—Ç–µ–º ¬´–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã¬ª –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="saveWorkerSettings()" id="btnSave">
                        <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                    <button class="btn btn-warning" onclick="restartWorkers()" id="btnRestart">
                        <i class="bi bi-arrow-repeat"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Architecture Diagram -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-diagram-3"></i> –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ—á–µ—Ä–µ–¥–µ–π
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>–¢–∏–ø –∑–∞–¥–∞—á–∏</th>
                                <th>–û—á–µ—Ä–µ–¥—å</th>
                                <th>–í–æ—Ä–∫–µ—Ä</th>
                                <th>–ü–æ—Ç–æ–∫–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><i class="bi bi-fire text-primary"></i> –ü—Ä–æ–≥—Ä–µ–≤ –ø—Ä–æ—Ñ–∏–ª–µ–π</td>
                                <td><span class="badge bg-primary">warmup</span> <span class="badge bg-secondary">default</span></td>
                                <td>celery_warmup</td>
                                <td id="archWarmupConc">-</td>
                                <td id="archWarmupStatus"><span class="badge bg-secondary">‚Äî</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-geo-alt-fill text-success"></i> –ö–ª–∏–∫–∏ –ø–æ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞–º</td>
                                <td><span class="badge bg-success">yandex_maps</span></td>
                                <td>celery_yandex_maps</td>
                                <td id="archMapsConc">-</td>
                                <td id="archMapsStatus"><span class="badge bg-secondary">‚Äî</span></td>
                            </tr>
                            <tr>
                                <td><i class="bi bi-search text-warning"></i> –ö–ª–∏–∫–∏ –ø–æ –Ø–Ω–¥–µ–∫—Å –í—ã–¥–∞—á–µ</td>
                                <td><span class="badge bg-warning text-dark">yandex_search</span></td>
                                <td>celery_yandex_search</td>
                                <td id="archSearchConc">-</td>
                                <td id="archSearchStatus"><span class="badge bg-secondary">‚Äî</span></td>
                            </tr>
                            <tr class="table-light">
                                <td><i class="bi bi-tools text-muted"></i> –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</td>
                                <td><span class="badge bg-info">proxy</span> <span class="badge bg-dark">maintenance</span></td>
                                <td colspan="3" class="text-muted">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–æ—Ä–∫–µ—Ä–æ–º –ø—Ä–æ–≥—Ä–µ–≤–∞</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Workers Info -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-activity"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ—Ä–∫–µ—Ä—ã Celery</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadWorkerStatus()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="workersInfo">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–æ—Ä–∫–µ—Ä–∞—Ö...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restart Log -->
<div class="row mb-4" id="restartLogSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="bi bi-terminal"></i> –õ–æ–≥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
            </div>
            <div class="card-body">
                <pre id="restartLog" class="bg-dark text-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Load current settings and status
    async function loadWorkerStatus() {
        try {
            const resp = await fetch('/api/workers/status');
            const data = await resp.json();
            
            // Update queue counts
            document.getElementById('warmupQueueLen').textContent = (data.queues?.warmup || 0) + (data.queues?.default || 0);
            document.getElementById('mapsQueueLen').textContent = data.queues?.yandex_maps || 0;
            document.getElementById('searchQueueLen').textContent = data.queues?.yandex_search || 0;
            
            // Update settings inputs from DB
            if (data.settings) {
                if (data.settings.worker_warmup_concurrency !== undefined) 
                    document.getElementById('warmupConcurrency').value = data.settings.worker_warmup_concurrency;
                if (data.settings.worker_yandex_maps_concurrency !== undefined) 
                    document.getElementById('mapsConcurrency').value = data.settings.worker_yandex_maps_concurrency;
                if (data.settings.worker_yandex_search_concurrency !== undefined) 
                    document.getElementById('searchConcurrency').value = data.settings.worker_yandex_search_concurrency;
                if (data.settings.worker_warmup_enabled !== undefined) 
                    document.getElementById('warmupEnabled').checked = data.settings.worker_warmup_enabled;
                if (data.settings.worker_yandex_maps_enabled !== undefined) 
                    document.getElementById('mapsEnabled').checked = data.settings.worker_yandex_maps_enabled;
                if (data.settings.worker_yandex_search_enabled !== undefined) 
                    document.getElementById('searchEnabled').checked = data.settings.worker_yandex_search_enabled;
                if (data.settings.worker_warmup_memory_limit !== undefined) 
                    document.getElementById('warmupMemory').value = data.settings.worker_warmup_memory_limit;
                if (data.settings.worker_yandex_maps_memory_limit !== undefined) 
                    document.getElementById('mapsMemory').value = data.settings.worker_yandex_maps_memory_limit;
                if (data.settings.worker_yandex_search_memory_limit !== undefined) 
                    document.getElementById('searchMemory').value = data.settings.worker_yandex_search_memory_limit;
            }
            
            // Update workers info table
            let workersHtml = '';
            
            if (data.worker_stats && Object.keys(data.worker_stats).length > 0) {
                workersHtml = '<table class="table table-sm table-hover mb-0"><thead><tr><th>–í–æ—Ä–∫–µ—Ä</th><th>–ü–æ—Ç–æ–∫–∏</th><th>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</th><th>–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th></tr></thead><tbody>';
                
                for (const [name, stats] of Object.entries(data.worker_stats)) {
                    const activeCnt = data.active_tasks[name] || 0;
                    const totalTasks = stats.total_tasks || {};
                    const totalSum = Object.values(totalTasks).reduce((a, b) => a + b, 0);
                    
                    // Determine worker type by name
                    let workerType = 'secondary';
                    let workerIcon = 'bi-gear';
                    if (name.includes('warmup') || (!name.includes('yandex') && !name.includes('search'))) {
                        workerType = 'primary';
                        workerIcon = 'bi-fire';
                    } else if (name.includes('yandex_maps') || name.includes('maps')) {
                        workerType = 'success';
                        workerIcon = 'bi-geo-alt-fill';
                    } else if (name.includes('yandex_search') || name.includes('search')) {
                        workerType = 'warning';
                        workerIcon = 'bi-search';
                    }
                    
                    workersHtml += `<tr>
                        <td><i class="bi ${workerIcon} text-${workerType}"></i> ${name}</td>
                        <td><span class="badge bg-${workerType}">${stats.concurrency}</span></td>
                        <td>${activeCnt}</td>
                        <td>${totalSum}</td>
                    </tr>`;
                    
                    // Update architecture table and stats  
                    if (name.includes('warmup') || (!name.includes('yandex') && !name.includes('search') && !name.includes('maps'))) {
                        document.getElementById('archWarmupConc').textContent = stats.concurrency;
                        document.getElementById('archWarmupStatus').innerHTML = `<span class="badge bg-success">–†–∞–±–æ—Ç–∞–µ—Ç</span>`;
                        document.getElementById('warmupActiveTasks').textContent = activeCnt;
                        document.getElementById('warmupTotalTasks').textContent = totalSum;
                    }
                    if (name.includes('yandex_maps') || name.includes('maps')) {
                        document.getElementById('archMapsConc').textContent = stats.concurrency;
                        document.getElementById('archMapsStatus').innerHTML = `<span class="badge bg-success">–†–∞–±–æ—Ç–∞–µ—Ç</span>`;
                        document.getElementById('mapsActiveTasks').textContent = activeCnt;
                        document.getElementById('mapsTotalTasks').textContent = totalSum;
                    }
                    if (name.includes('yandex_search') || name.includes('search')) {
                        document.getElementById('archSearchConc').textContent = stats.concurrency;
                        document.getElementById('archSearchStatus').innerHTML = `<span class="badge bg-success">–†–∞–±–æ—Ç–∞–µ—Ç</span>`;
                        document.getElementById('searchActiveTasks').textContent = activeCnt;
                        document.getElementById('searchTotalTasks').textContent = totalSum;
                    }
                }
                
                workersHtml += '</tbody></table>';
            } else {
                workersHtml = `<div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle"></i> 
                    –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                </div>`;
            }
            
            document.getElementById('workersInfo').innerHTML = workersHtml;
            
        } catch (err) {
            console.error('Error loading worker status:', err);
            document.getElementById('workersInfo').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}
                </div>`;
        }
    }

    // Adjust numeric input value
    function adjustValue(elementId, delta) {
        const el = document.getElementById(elementId);
        const newVal = Math.max(1, parseInt(el.value || 1) + delta);
        el.value = newVal;
    }

    // Save settings to DB
    async function saveWorkerSettings() {
        const btn = document.getElementById('btnSave');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –°–æ—Ö—Ä–∞–Ω—è—é...';
        
        const data = {
            worker_warmup_concurrency: parseInt(document.getElementById('warmupConcurrency').value),
            worker_yandex_maps_concurrency: parseInt(document.getElementById('mapsConcurrency').value),
            worker_yandex_search_concurrency: parseInt(document.getElementById('searchConcurrency').value),
            worker_warmup_enabled: document.getElementById('warmupEnabled').checked,
            worker_yandex_maps_enabled: document.getElementById('mapsEnabled').checked,
            worker_yandex_search_enabled: document.getElementById('searchEnabled').checked,
            worker_warmup_memory_limit: parseInt(document.getElementById('warmupMemory').value),
            worker_yandex_maps_memory_limit: parseInt(document.getElementById('mapsMemory').value),
            worker_yandex_search_memory_limit: parseInt(document.getElementById('searchMemory').value),
        };
        
        try {
            const resp = await fetch('/api/workers/apply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await resp.json();
            
            if (resp.ok) {
                showToast('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ù–∞–∂–º–∏—Ç–µ "–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã" –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.', 'success');
            } else {
                showToast('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.detail || 'Unknown error'), 'danger');
            }
        } catch (err) {
            showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏';
        }
    }

    // Restart workers
    async function restartWorkers() {
        if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –≤–æ—Ä–∫–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏? –¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.')) {
            return;
        }
        
        const btn = document.getElementById('btnRestart');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...';
        
        try {
            const resp = await fetch('/api/workers/restart', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: '{}'
            });
            const result = await resp.json();
            
            // Show restart log
            document.getElementById('restartLogSection').style.display = 'block';
            document.getElementById('restartLog').textContent = result.output || result.message || '–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–ø—É—â–µ–Ω';
            
            if (resp.ok) {
                showToast('üîÑ –í–æ—Ä–∫–µ—Ä—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è...', 'info');
                // Reload status after a delay
                setTimeout(loadWorkerStatus, 10000);
            } else {
                showToast('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: ' + (result.detail || 'Unknown error'), 'danger');
            }
        } catch (err) {
            showToast('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä—ã';
        }
    }

    // Auto-refresh
    let refreshInterval;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadWorkerStatus();
        refreshInterval = setInterval(loadWorkerStatus, 15000); // every 15 sec
    });
</script>
{% endblock %}
